# Lovelace "Power Analysis" Wizard view
# Use this as a view inside a YAML dashboard, or copy cards into your UI dashboard via Raw configuration editor.
# Notes:
# - Buttons use the provided button entities/services from the integration.
# - The instruction card shows the current circuit and wait time during measurement.
# - Add/remove circuit effect sensors to match your wiring.

views:
  - title: Power Analysis
    path: power-analysis
    icon: mdi:flash
    badges: []
    cards:
      # Kopfbereich: Untracked Gauge + Kennzahlen
      - type: grid
        columns: 2
        square: false
        cards:
          - type: gauge
            name: Nicht erfasste Leistung
            entity: sensor.power_consumption_analyser_untracked_power
            min: 0
            max: 1000
            needle: true
            severity:
              green: 0
              yellow: 150
              red: 400
          - type: entities
            title: Kennzahlen
            show_header_toggle: false
            entities:
              - entity: sensor.power_consumption_analyser_tracked_power_sum
                name: Erfasste Leistung
              - entity: sensor.power_consumption_analyser_tracked_coverage
                name: Abdeckung
              - entity: sensor.power_consumption_analyser_tracked_untracked_ratio
                name: Verh√§ltnis Erfasst/Nichterfasst

      # Aktueller Schritt ‚Äì nur sichtbar, wenn Workflow aktiv ist
      - type: conditional
        conditions:
          - entity: sensor.power_consumption_analyser_workflow_progress
            state: active
        card:
          type: vertical-stack
          cards:
            - type: markdown
              title: Aktueller Schritt
              content: |
                {% set wp = state_attr('sensor.power_consumption_analyser_workflow_progress', 'current') %}
                {% set rem = states('sensor.power_consumption_analyser_countdown') %}
                {% if wp %}
                Schalte jetzt Stromkreis **{{ wp }}** AUS.  
                Restzeit: **{{ rem if rem not in ['unknown','unavailable'] else '‚Äî' }} s**
                {% else %}
                Kein aktiver Schritt.
                {% endif %}
            - type: entities
              entities:
                - entity: sensor.power_consumption_analyser_countdown
                  name: Restzeit (Sekunden)
            - type: horizontal-stack
              cards:
                - type: button
                  name: Weiter
                  icon: mdi:arrow-right
                  tap_action:
                    action: call-service
                    service: power_consumption_analyser.workflow_finish_current
                - type: button
                  name: √úberspringen
                  icon: mdi:skip-next
                  tap_action:
                    action: call-service
                    service: power_consumption_analyser.workflow_skip_current
                - type: button
                  name: Stopp
                  icon: mdi:stop
                  tap_action:
                    action: call-service
                    service: power_consumption_analyser.workflow_stop
            - type: markdown
              title: Letztes Ergebnis
              content: |
                {% set done = state_attr('sensor.power_consumption_analyser_workflow_progress', 'done') or [] %}
                {% if done %}
                {% set last = done|last %}
                {% set eid = 'sensor.power_consumption_analyser_circuit_' ~ last|lower ~ '_effect' %}
                {% set eff = states(eid) %}
                {% set valid = state_attr(eid, 'valid') %}
                {% set clamped = state_attr(eid, 'clamped') %}
                {% set samples = state_attr(eid, 'samples') %}
                {% set mad = state_attr(eid, 'mad') %}
                {% set sigma = state_attr(eid, 'sigma') %}
                Letzter Schritt: **{{ last }}** ‚Äî Effekt: **{{ eff if eff not in ['unknown','unavailable', None] else '‚Äî' }} W**  
                Qualit√§t: {% if valid %}‚úÖ g√ºltig{% else %}‚ö†Ô∏è ung√ºltig{% endif %}{% if clamped %} ‚Ä¢ geklemmt{% endif %} ‚Ä¢ n={{ samples or '‚Äì' }} ‚Ä¢ MAD={{ mad or '‚Äì' }} ‚Ä¢ œÉ={{ sigma or '‚Äì' }}
                {% else %}
                Noch keine Ergebnisse.
                {% endif %}

      # Globale Steuerung (kompakt)
      - type: horizontal-stack
        cards:
          - type: button
            entity: button.start_workflow
            name: Start
            icon: mdi:play
            tap_action:
              action: call-service
              service: button.press
              service_data:
                entity_id: button.start_workflow
          - type: button
            entity: button.stop_workflow
            name: Stopp
            icon: mdi:stop
            tap_action:
              action: call-service
              service: button.press
              service_data:
                entity_id: button.stop_workflow
          - type: button
            entity: button.reset_values
            name: Reset
            icon: mdi:backup-restore
            tap_action:
              action: call-service
              service: button.press
              service_data:
                entity_id: button.reset_values

      # Fortschritt (kompakt)
      - type: markdown
        title: Fortschritt
        content: |
           {% set done = state_attr('sensor.power_consumption_analyser_workflow_progress', 'done') %}
           {% set rem = state_attr('sensor.power_consumption_analyser_workflow_progress', 'remaining') %}
           {% if done and done|length %}
           Abgeschlossen: {{ done|join(', ') }}
           {% else %}
           Noch nichts abgeschlossen.
           {% endif %}

           {% if rem and rem|length %}
           Offen: {{ rem|join(', ') }}
           {% else %}
           Keine offenen Schritte.
           {% endif %}

      # Verlauf & Abdeckung
      - type: grid
        columns: 2
        square: false
        cards:
          - type: history-graph
            title: Lastverlauf (6h)
            hours_to_show: 6
            entities:
              - sensor.power_consumption_analyser_untracked_power
              - sensor.power_consumption_analyser_tracked_power_sum
          - type: statistics-graph
            title: Abdeckung (24h)
            period: hour
            days_to_show: 1
            stat_types:
              - mean
            entities:
              - sensor.power_consumption_analyser_tracked_coverage

      # Unterverteilung: RCDs und Sicherungen
      - type: markdown
        title: Unterverteilung
        content: |
           {% set rcds = state_attr('sensor.power_consumption_analyser_rcd_layout', 'rcds') or [] %}
           {% set layout = state_attr('sensor.power_consumption_analyser_rcd_layout', 'layout') or {} %}
           {% set done = state_attr('sensor.power_consumption_analyser_rcd_layout', 'done') or [] %}
           {% set current = state_attr('sensor.power_consumption_analyser_rcd_layout', 'current') %}
           {% if rcds %}
           {% for r in rcds %}
           ### {{ r }}
           {% set circuits = layout.get(r, []) %}
           {% if circuits %}
           {% for c in circuits %}
           {% set eid = 'sensor.power_consumption_analyser_circuit_' ~ c|lower ~ '_effect' %}
           {% set eff = states(eid) %}
           {% if eff in [None, 'unknown', 'unavailable'] %}{% set eff_txt = '‚Äî' %}{% else %}{% set eff_txt = eff ~ ' W' %}{% endif %}
           {% if c in done %}- ‚úÖ {{ c }} ({{ eff_txt }})
           {% elif c == current %}- üî∂ {{ c }} ({{ eff_txt }})
           {% else %}- ‚è≥ {{ c }} ({{ eff_txt }})
           {% endif %}
           {% endfor %}
           {% else %}
           (keine Sicherungen)
           {% endif %}
           {% endfor %}
           {% else %}
           (keine RCD-Gruppen gefunden)
           {% endif %}
