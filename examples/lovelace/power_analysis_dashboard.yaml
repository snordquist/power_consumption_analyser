# Lovelace "Power Analysis" Wizard view
# Use this as a view inside a YAML dashboard, or copy cards into your UI dashboard via Raw configuration editor.
# Notes:
# - Buttons use the provided button entities/services from the integration.
# - The instruction card shows the current circuit and wait time during measurement.
# - Add/remove circuit effect sensors to match your wiring.

views:
  - title: Power Analysis
    path: power-analysis
    icon: mdi:flash
    badges: []
    cards:
      # Status section
      - type: entities
        title: Status
        show_header_toggle: false
        entities:
          - entity: sensor.power_consumption_analyser_measurement_status
            name: Measurement Status
          - entity: sensor.power_consumption_analyser_analysis_status
            name: Analysis Status
          - entity: sensor.power_consumption_analyser_untracked_power
            name: Untracked Power
          - entity: sensor.power_consumption_analyser_tracked_power_sum
            name: Tracked Power Sum
          - entity: sensor.power_consumption_analyser_tracked_coverage
            name: Tracked Coverage
          - entity: sensor.power_consumption_analyser_tracked_untracked_ratio
            name: Tracked/Untracked Ratio
          - entity: sensor.power_consumption_analyser_measurement_summary
            name: Measurement Summary

      # Instruction (only while measuring)
      - type: conditional
        conditions:
          - entity: sensor.power_consumption_analyser_measurement_status
            state_not: idle
        card:
          type: markdown
          title: Anleitung
          content: >-
            {% set st = states('sensor.power_consumption_analyser_measurement_status') %}
            {% set parts = st.split(':') %}
            {% if parts|length >= 2 %}
            Schalte jetzt Stromkreis **{{ parts[1] }}** AUS.
            {% if parts|length >= 3 %} Warte **{{ parts[2] }}**.{% endif %}
            {% else %}
            Messung l√§uft‚Ä¶
            {% endif %}

      # Countdown
      - type: conditional
        conditions:
          - entity: sensor.power_consumption_analyser_measurement_status
            state_not: idle
        card:
          type: entities
          title: Countdown
          entities:
            - entity: timer.pca_step
              name: Restzeit

      # Controls: global device buttons
      - type: horizontal-stack
        cards:
          - type: button
            entity: button.start_workflow
            name: Start
            icon: mdi:play
            tap_action:
              action: call-service
              service: button.press
              service_data:
                entity_id: button.start_workflow
          - type: button
            entity: button.stop_workflow
            name: Stopp
            icon: mdi:stop
            tap_action:
              action: call-service
              service: button.press
              service_data:
                entity_id: button.stop_workflow
          - type: button
            entity: button.reset_values
            name: Reset
            icon: mdi:backup-restore
            tap_action:
              action: call-service
              service: button.press
              service_data:
                entity_id: button.reset_values

      # Controls: service buttons (Skip / Restart)
      - type: horizontal-stack
        cards:
          - type: button
            name: √úberspringen
            icon: mdi:skip-next
            tap_action:
              action: call-service
              service: power_consumption_analyser.workflow_skip_current
          - type: button
            name: Neu starten
            icon: mdi:restart
            tap_action:
              action: call-service
              service: power_consumption_analyser.workflow_restart

      # Effects per circuit (add/remove your circuit sensors)
      - type: entities
        title: Effekte je Stromkreis (Beispiele ‚Äì bitte anpassen)
        show_header_toggle: false
        entities:
          - sensor.power_consumption_analyser_circuit_1f1_effect
          - sensor.power_consumption_analyser_circuit_1f2_effect
          - sensor.power_consumption_analyser_circuit_2f7_effect
          - sensor.power_consumption_analyser_circuit_3f11_effect

      # History / graphs
      - type: history-graph
        title: Lastverlauf (6h)
        hours_to_show: 6
        entities:
          - sensor.power_consumption_analyser_untracked_power
          - sensor.power_consumption_analyser_tracked_power_sum
      - type: statistics-graph
        title: Abdeckung (24h)
        period: hour
        days_to_show: 1
        stat_types:
          - mean
        entities:
          - sensor.power_consumption_analyser_tracked_coverage

      # Workflow progress visualization
      - type: markdown
        title: Fortschritt
        content: >-
          {% set attrs = state_attr('sensor.power_consumption_analyser_workflow_progress', 'done') %}
          {% set rem = state_attr('sensor.power_consumption_analyser_workflow_progress', 'remaining') %}
          {% if attrs %}
          Abgeschlossen:
          {% for c in attrs %}
          - ‚úÖ {{ c }}
          {% endfor %}
          {% else %}
          Noch nichts abgeschlossen.
          {% endif %}

          {% if rem %}
          Offen:
          {% for c in rem %}
          - ‚è≥ {{ c }}
          {% endfor %}
          {% else %}
          Keine offenen Schritte.
          {% endif %}

      # Unterverteilung: RCDs und Sicherungen
      - type: markdown
        title: Unterverteilung
        content: >-
          {% set rcds = state_attr('sensor.power_consumption_analyser_rcd_layout', 'rcds') or [] %}
          {% set layout = state_attr('sensor.power_consumption_analyser_rcd_layout', 'layout') or {} %}
          {% set done = state_attr('sensor.power_consumption_analyser_rcd_layout', 'done') or [] %}
          {% set current = state_attr('sensor.power_consumption_analyser_rcd_layout', 'current') %}
          {% if rcds %}
          {% for r in rcds %}
          ### {{ r }}
          {% set circuits = layout.get(r, []) %}
          {% if circuits %}
          {% for c in circuits %}
          {% if c in done %}- ‚úÖ {{ c }}
          {% elif c == current %}- üî∂ {{ c }}
          {% else %}- ‚è≥ {{ c }}
          {% endif %}
          {% endfor %}
          {% else %}
          (keine Sicherungen)
          {% endif %}
          {% endfor %}
          {% else %}
          (keine RCD-Gruppen gefunden)
          {% endif %}

      # Unterverteilung: RCDs und Sicherungen (Grid)
      - type: markdown
        title: Unterverteilung (Grid)
        content: >-
          {% set rcds = state_attr('sensor.power_consumption_analyser_rcd_layout', 'rcds') or [] %}
          {% set layout = state_attr('sensor.power_consumption_analyser_rcd_layout', 'layout') or {} %}
          {% set done = state_attr('sensor.power_consumption_analyser_rcd_layout', 'done') or [] %}
          {% set current = state_attr('sensor.power_consumption_analyser_rcd_layout', 'current') %}
          {% set cols = 4 %}
          {% if rcds %}
          {% for r in rcds %}
          #### {{ r }}
          {% set circuits = layout.get(r, []) %}
          {% if circuits %}
          <table>
          {% for i in range(0, circuits|length, cols) %}
            <tr>
            {% for c in circuits[i:i+cols] %}
              <td style="padding:6px 12px;">
                {% if c in done %}
                  ‚úÖ <strong>{{ c }}</strong>
                {% elif c == current %}
                  üî∂ <strong>{{ c }}</strong>
                {% else %}
                  ‚è≥ <strong>{{ c }}</strong>
                {% endif %}
              </td>
            {% endfor %}
            </tr>
          {% endfor %}
          </table>
          {% else %}
          (keine Sicherungen)
          {% endif %}
          {% endfor %}
          {% else %}
          (keine RCD-Gruppen gefunden)
          {% endif %}
